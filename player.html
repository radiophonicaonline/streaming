<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { margin:0; background:black; overflow:hidden; }

video{
  width:100vw;
  height:100vh;
  object-fit:contain;
  opacity:1;
  transition:opacity 0.8s ease;
}
</style>
</head>
<body>

<video id="video" autoplay></video>

<script>
const video = document.getElementById("video");
const canal = new BroadcastChannel("obs_player");

let playlist = [];
let index = 0;

function fadeOut(cb){
  video.style.opacity = 0;
  setTimeout(cb, 800);
}

function fadeIn(){
  video.style.opacity = 1;
}

function playFile(file){
  fadeOut(()=>{
    video.src = URL.createObjectURL(file);
    video.play();
    fadeIn();
  });
}

function playRandom(){
  if(!playlist.length) return;
  index = Math.floor(Math.random()*playlist.length);
  playFile(playlist[index]);
}

canal.onmessage = e => {
  const msg = e.data;

  if(msg.type === "addFiles"){
    playlist.push(...msg.files);
  }

  if(msg.type === "playIndex"){
    playlist = msg.files;
    index = msg.index;
    playFile(playlist[index]);
  }

  if(msg.type === "playRandom"){
    playlist = msg.files;
    playRandom();
  }

  if(msg.type === "pause") video.pause();
  if(msg.type === "play") video.play();

  if(msg.type === "stop"){
    video.pause();
    video.currentTime = 0;
  }

  if(msg.type === "next"){
    playRandom();
  }
};
</script>

</body>
</html>
