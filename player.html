<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body{margin:0;background:black;overflow:hidden}

video{
  width:100vw;
  height:100vh;
  object-fit:contain;
  opacity:1;
  transition:opacity 0.8s ease;
}
</style>
</head>
<body>

<video id="video" autoplay></video>

<script>
const video = document.getElementById("video");
const canal = new BroadcastChannel("obs_player");

let autoplay = true;
let currentFiles = [];

function fadeOut(cb){
  video.style.opacity = 0;
  setTimeout(cb, 800);
}

function fadeIn(){ video.style.opacity = 1; }

function playFile(file){
  fadeOut(()=>{
    video.src = URL.createObjectURL(file);
    video.play();
    fadeIn();
  });
}

function playRandom(files){
  if(!files.length) return;
  const i = Math.floor(Math.random()*files.length);
  currentFiles = files;
  playFile(files[i]);
}

video.onended = ()=>{
  if(autoplay && currentFiles.length){
    playRandom(currentFiles);
  }
};

canal.onmessage = e=>{
  const msg = e.data;

  if(msg.type === "playFile"){
    autoplay = false;
    playFile(msg.file);
  }

  if(msg.type === "playFolder"){
    autoplay = true;
    playRandom(msg.files);
  }

  if(msg.type === "setAutoplay"){
    autoplay = msg.value;
  }

  if(msg.type === "pause") video.pause();
  if(msg.type === "play") video.play();

  if(msg.type === "stop"){
    video.pause();
    video.currentTime = 0;
  }

  if(msg.type === "fx"){
    const fx = new Audio(URL.createObjectURL(msg.file));
    fx.play();
  }
};
</script>

</body>
</html>
